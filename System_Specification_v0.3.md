# מסמך אפיון מערכת: אוטומציה לטיפול בהיזון חוזר פנסיוני – "השקט שלך"

**גרסה:** 0.3 (עדכון מדיניות מיילים ואינטגרציית G-Suite)  
**תאריך:** 6 בדצמבר 2025  
**לקוח:** חברת "השקט שלך"

---

## 1. תקציר מנהלים ומטרת הפרויקט
מטרת הפרויקט היא לייעל ולבצע אוטומציה לתהליך הטיפול בשגיאות המתקבלות בקבצי "היזון חוזר" מהמסלקה הפנסיונית. כיום התהליך מתבצע ידנית ע"י מנהלות תיקים.  
המערכת המתוכננת תבצע ניתוח אוטומטי של הקבצים, תזהה שגיאות, תמיין אותן לפי חוקים עסקיים מוגדרים מראש, ותכין טיוטות מיילים לטיפול מול מעסיקים וגופים מוסדיים.  
**היעד:** צמצום הטיפול הידני למינימום והשארת המקרים המורכבים בלבד למנהל אנושי.

---

## 2. תהליך העבודה (Workflow) - רמת המאקרו

### 2.1 קלט (Input)
1. **קובץ היזון חוזר:** קובץ Excel/XML המתקבל מהמסלקה הפנסיונית. מכיל שורות דיווח ברמת עובד בודד.
2. **קובץ מיפוי שגיאות (Mapping):** טבלת חוקים המגדירה לכל קוד שגיאה מי האחראי ומהו נוסח הטיפול (`error_code_mapping_final.xlsx`).

### 2.2 עיבוד וזיהוי (Processing)
1. **שליפת נתונים (Ingestion):** המערכת תבצע שליפה שבועית (Bulk) מה-API של הפורטל. כל רשומה תכלול את שדות הליבה וכן את שדה `StatusLastUpdateDate` (תאריך עדכון סטטוס אחרון), `FeedbackStatus`, `ErrorCodeV4Id`, השילוב של `KodKupa_IdentityNumber` ו־`KodKupa_IncomeTax`, פרטי המעסיק ופרטי הלקוח (`CustomerNumber`, `MISPAR_MEZAHE_OVED`).
2. **סינון זמן וסטטוס:**
   - סינון לפי `UpdateDate` או `StatusLastUpdateDate` (רשומות שעודכנו בשבוע האחרון). הקובץ נגיש לעיבוד החל מיום שלישי בבוקר בכל שבוע.
   - סינון לפי 4 הסטטוסים המוגדרים לטיפול:
     - רשומה הועברה לטיפול מעסיק
     - רשומה לא נקלטה על ידי יצרן - נדחה על ידי יצרן
     - רשומה לא נקלטה על ידי יצרן - הועבר להמשך טיפול אצל יצרן
     - רשומה נקלטה - נמצא חוסר בא.כ.ע
3. **חישוב משך תקלה (Duration Calculation):**
   - לכל רשומה נחשב במשך כמה שבועות היא נמצאת באותו סטטוס באמצעות `StatusLastUpdateDate`ועד לשבוע הנוכחי.
   - הנתון אינו נחשף ישירות למעסיק, אך משמש לניתוח פנימי ולביצוע escalations / תזכורות.
4. **מיפוי שגיאות:** הצמדת הוראות טיפול לפי קוד שגיאה (`ErrorCodeV4Id`) בהתאם לקובץ `error_code_mapping_final.xlsx` (כולל גורם אחראי והזנת מפתח לתבניות המייל).  
   - המיילים עצמם (נושא/גוף) לא נשמרים בשלב 2.2 אלא נשאבים מהטבלה רק לפני שלב 2.3/3. יצירת טיוטת מייל תקבל את `ErrorCodeV4Id` ותבחר את התבנית המתאימה.
5. **קבוצת נתונים (Aggregation):** הנתונים מוקבצים ברמת מפתח ייחודי: מעסיק + קוד קופה (שילוב `KodKupa_*`) + קוד שגיאה על מנת להציג כמות ת.ז. יחודיות לכל טיפול.
6. **ניהול קודים מיוחדים:** עבור קודים 4, 5, 15, 93 נדרשת בדיקה נוספת – שאלת ה־API של הפורטל או היסטוריית הנתונים (חודשים קודמים) כדי לקבוע האם הייתה קליטה תקינה בעבר. במידה והבדיקה חיובית – האחריות עוברת לגוף המוסדי והמערכת תשתמש בתבנית מייל אחרת, אחרת נשארת אצל המעסיק.

### 2.3 לוגיקה עסקית (Business Logic)
1. **בדיקת מונה חזרות (Retry Logic):**
   - המערכת תשתמש בחישוב משך הסטטוס (מסעיף 2.2) כדי לקבוע אם זו פנייה ראשונה, תזכורת או אסקלציה (Week Counter). Counter = 1 → פנייה ראשונה, Counter = 2 → תזכורת מסומנת, Counter ≥ 3 → מותאם לרמת דחיפות/אנשי קשר מיוחדים.
   - **מדיניות מיילים:** בכל שלב נוצר מייל חדש. במקרים בהם Counter ≥ 2 יתווסף מלל של תזכורת/דחיפות, ובמידה ו־ Counter ≥ 3 יכללו רשימת נמענים מורחבת לפי החוקיות.
   - **הערה:** הטקסט המדויק של משך הזמן אינו מוצג למעסיק – רק לצורך בקרה פנימית.
2. **בדיקת אחריות ותנאי מיוחד (Override):**
   - עבור קודים 4, 5, 15, 93 המערכת תבצע שאילתה להיסטוריית הסטטוס (חודשים קודמים). אם נרשמה קליטה תקינה בעבר → אפקטיביות האחריות עוברת לגוף המוסדי, תבנית המייל תשתנה והכיול ישמע על צירוף הגורם המתאים.
3. **הכנת תוצרים:** יצירת טיוטות מייל (Drafts) ל־Gmail, כולל קובץ בקרה רוחבי ואפשרות לרשום כל טיוטה ב־log או Excel שיסופק למנהלת התיק ול־Salesforce.

### 2.4 פלט וסטטיסטיקה (Output & Analytics)
1. **טיוטות מייל (Drafts):** יצירת טיוטות ב-Gmail לאישור ידני.
2. **דוח בקרה וסטטיסטיקה (שלב 6):**
   - המערכת תייצר דוח מנתח הכולל: כמות שגיאות, פילוח לפי מעסיק/קופה, ופילוח לפי "משך זמן טיפול" (Age of Error).
   - הדוח יישלח חזרה לפורטל הארגוני באמצעות API ייעודי (Push) או יישלח במייל למנהלים.

---

## 3. ארכיטקטורה טכנית מוצעת

### 3.1 מנוע האוטומציה (Orchestration)
- **כלי נבחר:** **n8n** (Self-Hosted).
- **דרישת חובה:** כתובת IP סטטית (Static IP) לטובת חיבור ל-API של "השקט שלך".

### 3.2 מסד נתונים ולוגיקה
- **ניהול חוקים:** קובץ המיפוי יומר לטבלה ב-DB.
- **לוגיקה:** סקריפטים של Python (בתוך n8n) לחישוב Duration ואגרגציה.

### 3.3 אינטגרציות נדרשות (Integrations)
1. **מערכת הליבה ("השקט שלך"):**
   - **API נדרש:** `GetFeedbackData` – תומך בסינון `UpdateDate` ו־`FeedbackStatus`, מחזיר את כל השדות הקריטיים (סטטוס, קוד שגיאה, קוד קופה, מזהה עובד, תאריכים).  
   - **API נדרש:** `GetEmployerContacts` – נדרש כדי למשוך כתובות מייל/שמות גורמים פנימיים או חיצוניים לעדכון הטיוטות, כולל אפשרות להורדת קבצים מצורפים.
   - **API נדרש:** `GetHistoricalStatus` (או שאילתה דומה) עבור קודים 4,5,15,9-3 – לשליפת רשומות מהחודשים הקודמים שמוגדרות כקליטה תקינה.  
   - **API נדרש:** `PostAnalyticsReport` – על מנת לשלוח חזרה את הסטטיסטיקות (פורמט JSON/Excel) לפורטל התפעולי.
2. **Salesforce ותיעוד טיפול:**
   - נעדכן רשומה או משימה ב־Salesforce עבור כל קבוצה שהמערכת מטפלת בה, כולל Counter, תאריך העדכון האחרון, והערות תזכורת.  
   - נשתמש ב־Salesforce כדי לזהות גורמים מטפלים (Owner) ולעדכן אותם כאשר יש escalation (Counter ≥ 3).  
3. **G-Suite (Google Workspace):**
   - אינטגרציה לשרת המיילים הארגוני של "השקט שלך".  
   - שימוש ב-**Gmail API** ליצירת טיוטות (drafts.create) עם Scope מצומצם (לא לשליחה).  
   - לוג של כל טיוטה (תאריך, נושא, נמענים, קובץ בקרה).  
   - קבצים מצורפים או קישורי Dashboard יוכלו להיווצר באמצעות ראיה ב־Drive/Sheets.

---

## 4. פערים לטיפול בהמשך (Gap Analysis)
1. **אפיון ממשק הסטטיסטיקה:** יש להגדיר בדיוק את מבנה ה-JSON שהפורטל מצפה לקבל בשלב 6.
2. **בחינת מנגנון Reply All:** הנושא נדחה לשלב ב' (כאמור בסעיף 2.3).
3. **תבניות מייל:** יש להקים מנגנון HTML Template המסתיר את נתון ה"זמן" מהמעסיק אך שומר אותו במידע למנהלת.
4. **עדכון ממשקי API נוספים:** יש לאשר את ה־Endpoints ל־GetHistoricalStatus (קודי 4,5,15,93) ול־GetEmployerContacts כולל קבצים מצורפים/ניתוב קישורים, כדי לתכנן את טיוטות המייל במלוא הנתונים.
